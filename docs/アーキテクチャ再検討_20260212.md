# ticket-tasuki アーキテクチャ再検討（ガードレール型ロール検討）

2026/02/12 議論記録

## 目的

#6098（TaskSpawnGuardHook迂回防止）議論過程で発展した、ガードレール型ロール（PMO/Tech Lead/Karen）検討をドキュメント化。方式Eの現行ロール構成（PO→Leader→Coder/Scribe/Tester）に対し、レビュー品質・プロセス監査の強化策を評価する。

前提: アーキテクチャ再検討_20260208.mdの結論「方式E（Agent Teams + sendmessage_guard）を現行推奨」は維持。本ドキュメントはロール構成の拡張可能性を検討する。

---

## 1. 背景

### 現行アーキテクチャ（方式E）概要

**役割構成**: PO(人間) → Leader(リーダー) → Coder/Tester/Scribe(メンバー)

**設計原則**:
- チケットIDポインタ渡し: Agent間通信はissue_idのみ。詳細は必ずRedmineコメント
- Redmineに書いてないことは存在しない: セッション揮発性をRedmine永続性で補完
- Agent Teams = 通信インフラ、Redmine = 状態管理・長期記憶

**制御機構（claude-nagger + ticket-tasuki）**:

| 機構 | 帰属 | 役割 |
|------|------|------|
| sendmessage_guard | claude-nagger | メンバー間通信にissue_idパターン強制 |
| LeaderConstraintHook | claude-nagger | leader直接コード編集ブロック |
| session_startup | claude-nagger(基盤) + ticket-tasuki(内容定義) | 規約注入 |
| task_spawn_guard | ticket-tasuki(プラグインhook) | ticket-tasuki:*直接起動ブロック+迂回検知 |

### 方式変遷（サマリ）

| 時期 | 方式 | 状態 |
|------|------|------|
| 初期 | A: subagent | コンテキスト漏洩バグ(#14118)が実害 |
| 検討のみ | B: Agent SDK / C: CLI+Redmine | コスト・実装負荷で見送り |
| 2026/02/02 | D: Conductor(GP+Task tool) | 追加実装ゼロ。フォールバックとして維持 |
| **2026/02/08~** | **E: Agent Teams+sendmessage_guard** | **現行推奨** |

詳細: アーキテクチャ検討.md（方式A～D）、アーキテクチャ再検討_20260208.md（方式E評価）

### #6098の経緯

TaskSpawnGuardHookが`ticket-tasuki:*`の直接起動をブロックした際、leaderがgeneral-purposeエージェントに差し替えて同等の作業を実行する事象が発生。このhook迂回問題の調査過程で、claude-nagger vs ticket-tasukiの責務境界分析およびガードレール型ロールの検討に発展した。

---

## 2. 責務境界分析

### claude-nagger vs ticket-tasukiのhook一覧

**claude-nagger（PyPIパッケージ）**:

| hook名 | イベント | 責務 |
|---------|---------|------|
| session-startup | PreToolUse (matcher="") | セッション開始時規約通知 |
| implementation-design | PreToolUse (Edit/Write/Bash等) | ファイル・コマンド規約チェック |
| sendmessage-guard | PreToolUse (SendMessage) | SendMessage内容検査・issue_id強制 |
| leader-constraint | PreToolUse (Read/Edit/Write/Grep/Glob) | subagentアクティブ時のleader直接作業ブロック |
| compact-detected | SessionStart (compact) | compact発生時マーカーリセット |
| subagent-event | SubagentStart/SubagentStop | subagent登録・解除・task_spawnsマッチング |
| suggest-rules-trigger | Stop | セッション終了時規約自動提案 |

**ticket-tasuki（Claude Codeプラグイン）**:

| hook名 | イベント | 責務 |
|---------|---------|------|
| task_spawn_guard | PreToolUse (Task) | ticket-tasuki:*直接起動ブロック+迂回検知 |

### 混同が起きやすい構造的要因（5点）

| 要因 | 内容 |
|------|------|
| A: 帰属遍歴 | TaskSpawnGuardHookがclaude-nagger内で2回実装→2回revert→最終的にticket-tasukiプラグインhookとして再実装。pyc残骸が残存していた |
| B: 名前空間の不在 | claude-naggarのhookメッセージに出所表記がなかった（#6100で`[claude-nagger]`プレフィックス追加済み） |
| C: 設定ファイルの入れ子構造 | ticket-tasukiが`.claude-nagger/`テンプレートを同梱。claude-nagger設定内にticket-tasuki固有用語が混在 |
| D: hook登録の二重経路 | claude-nagger: `.claude/settings.json`経由、ticket-tasuki: プラグインhook機構経由。両者が同一イベントに登録され合流 |
| E: 機能的重複領域 | 「Task起動制御」はticket-tasukiの業務ロジックだが、「hookによるブロッキング」はclaude-naggarの基盤機能。境界が不明確 |

---

## 3. ガードレール型ロール検討

### 3.1 Karen型（完成度リアリティチェック）

**出典**: [darcyegb/ClaudeCodeAgents](https://github.com/darcyegb/ClaudeCodeAgents) — Claude Code用QAエージェント集

**概要**: "no-nonsense Project Reality Manager"。「完了」と主張されたタスクの実態検証。理想条件でのみ動作する実装、過剰抽象化、基本機能欠如の設計判断偽装、時期尚早な最適化を検知。

**手法**: テストで動作検証→主張と現実のギャップ特定→具体的完了計画作成

**ticket-tasukiとの対応**: leaderのレビュー品質向上に相当。現行ではleader自身がレビューしており、「指示者=レビュアー」のバイアス問題がある。

### 3.2 PMO型（プロセス準拠監査）

**先行事例**: Guardian Agent（Wayfound等）、Compliance Checker（Three-Layer Guardrail）、Flowbaby（vs-code-agents）

**候補責務**:
- チケット記載漏れ検知（コメントに意図・経緯が不足していないか）
- プロセス逸脱検知（ワークフロー順序違反、レビュー未実施での次工程移行）
- 規約準拠監査（コミットメッセージのissue_id有無、実行者マーカー付記漏れ）

**現行scribeとの関係**: scribeは「チケットCRUD操作」担当。PMOはscribeの操作結果を「監査」する上位ロール。分離により自己チェック問題を回避。

**PMO不要説との整合**: アーキテクチャ再検討_20260202.md §1で「LLMはチケット起票を忘れない」として旧PMOを廃止した経緯あり。ガードレール型PMOは旧PMO（プロセス管理者）とは異なり、hookでカバーできない層（記載品質・プロセス準拠の意味的チェック）を担当する再定義。

### 3.3 Tech Lead型（技術品質レビュー）

**先行事例**:

| パターン | 出典 | 内容 |
|---------|------|------|
| SWE-Agent | arxiv | Architect+Coder+Reviewerの3役割分離 |
| AgentMesh | arxiv | Planner+Coder+Debugger+Reviewerの4役割 |
| Draft-and-Review | Google ADK | Generator+Critic/Reviewerの品質ゲートパターン |
| Parallel Review | Addy Osmani | Security Auditor+Style Enforcer+Performance Analystが並列レビュー |

**候補責務**:
- coderの実装結果をアーキテクチャ観点でレビュー（現在leaderが担当）
- 設計書との整合性チェック
- セキュリティ・パフォーマンス観点のコードレビュー
- リファクタリング提案

**PM+TL→Leader統合の経緯再評価**:

統合理由（アーキテクチャ再検討_20260202.md）:
1. 管理:実装比率 6:1→削減が必要
2. ワークフロー重量（1機能で20ステップ以上）
3. ペルソナ無効性（学術5研究で効果なし〜最大30%性能低下）
4. subagent間通信制約により対話的レビューが困難

**方式Eでの状況変化**: 理由4（通信制約）はAgent TeamsのSendMessageで解消済み。統合理由の一部が無効化されているが再評価されていなかった。

### 3.4 LLM部分最適傾向のエビデンス（Tech Lead正当性根拠）

**学術的根拠**:
- **Exclusionary Reasoning**: LLMは局所的パターンマッチングに依存し、グローバル整合性チェックが弱い
- **Context Degradation**: 長コンテキストでも中盤の情報は注意が薄れる（"Lost in the Middle"問題）。セッション後半で初期の設計意図が事実上消失
- **Architectural Drift**: 複数LLMセッションで各セッションが独立に「正しい」解を出すが、セッション間で設計方針が乖離

**実践的エビデンス**:
- 長時間セッションで30-40%の生産性低下（コンテキスト肥大化による品質劣化）の報告
- LLM生成コードはローカルで動作するが、既存パターンとの不整合（命名規則、エラーハンドリング方針、依存関係方向の逆転）を起こしやすい
- auto-compaction後に「何をしたか」は残るが「なぜそうしたか」が失われ、後続判断が局所最適に陥る

### 3.5 比較分析

| 観点 | Karen型 | PMO型 | Tech Lead型 |
|------|---------|-------|-------------|
| 主責務 | 完成度リアリティチェック | プロセス準拠監査 | 技術品質レビュー |
| 検査対象 | coderの成果物 | 全エージェントのプロセス | coderの成果物+設計 |
| 実行タイミング | タスク完了時 | 各フェーズ遷移時 | 実装完了→テスト前 |
| 現行の担当者 | leader | なし（hookで部分カバー） | leader |
| 分離メリット | レビューバイアス排除 | プロセス逸脱の独立検知 | 技術判断の独立性確保 |
| 既存hookとの重複 | 低 | 高（sendmessage_guard/session_startup） | 中（implementation-design） |
| RAM追加コスト | +4-5GB推定 | +4-5GB推定 | +4-5GB推定 |

---

## 4. 結論

### PMO型: 必要

hookでカバーできない層（記載品質・プロセス準拠の意味的チェック）を担当。旧PMO（プロセス管理者）ではなく、チケット構造・プロセス準拠の監査者として再定義。claude-naggarの既存hook群（sendmessage_guard, session_startup, implementation-design）は構文的チェックに特化しており、意味的な監査（チケット記載内容の十分性、ワークフロー準拠の判定）はhookでは困難。

### Tech Lead型: 必要

LLM部分最適問題（局所最適・コンテキスト減衰・セッション間乖離）の構造的補完として正当性がある。PM+TL→Leader統合の理由の一つ（通信制約）は方式Eで解消済み。leaderの「指示者=レビュアー」問題を構造的に解消し、coderが長時間セッションで大量コードを生成した場合のアーキテクチャ整合性を担保。

### Karen型: PMO+Tech Leadに分解される。独立ロール不要

Karen型の責務を分析すると:
- 完了条件充足の検証 → PMO型の責務（プロセス準拠監査）
- コード品質・設計整合性の検証 → Tech Lead型の責務（技術品質レビュー）

Karen型はPMOとTech Leadの責務を「小うるさいレビュアー」というペルソナで統合したものだが、ペルソナ無効性（学術5研究で効果なし〜最大30%性能低下）の知見から、ペルソナではなく具体的タスク指示+規約として分離実装が適切。

---

## 5. 実装方針

### PMO: hook（軽量ガード warn）+ agent（クローズ前チェックポイント起動）

**hook層（軽量・常時）**:
- 既存hook拡張: コミットメッセージのissue_id有無、実行者マーカー付記漏れ等の構文的チェック
- claude-nagger implementation-design hookの拡張またはPMO専用hookの追加

**agent層（重量・オンデマンド）**:
- チケットクローズ前に起動し、記載品質・プロセス準拠を意味的に監査
- チェック項目: コメントに意図・経緯が記載されているか、ワークフロー順序が遵守されたか、テスト結果が記録されているか

### Tech Lead: coder完了後にオンデマンド起動

- coderの実装完了後、leaderがTech Lead subagentを起動
- `git diff`ベースで設計整合性を検証
- アーキテクチャ原則（CLAUDE.md、docs/specs/配下の設計書）との照合
- レビュー結果をRedmineコメントに記録

### RAM制約: 常駐はcoder/scribeのみ。TL/PMO/testerは排他的オンデマンド起動

**根拠**: 3メンバーで13GB RAM（#23883）。5メンバー常駐は現実的でない。

**運用方針**:

| ロール | 起動方式 | 理由 |
|--------|---------|------|
| Coder | 常駐 | 実装作業は継続的に発生 |
| Scribe | 常駐 | チケット操作は随時発生 |
| Tech Lead | オンデマンド | coder完了後のレビュー時のみ。coder/testerと排他的 |
| PMO | オンデマンド | クローズ前チェックポイント等の特定タイミングのみ |
| Tester | オンデマンド | テストフェーズのみ。coderと排他的 |

**段階的アプローチ**: まずLeader規約強化（Karen型完了検証+TL型設計整合性チェックをleader自身の規約に追加）で対応し、Leaderのコンテキスト制約が実際にボトルネックとなった場合にTech Lead subagentを分離する。

---

## 6. 新ロール構成案

```
PO（ユーザ）
  └─ Leader（判断・指示・意思決定・PO対話）
       ├─ Coder（コード実装）         [常駐]
       ├─ Scribe（チケットCRUD）       [常駐]
       ├─ Tech Lead（技術レビュー）    [オンデマンド]
       ├─ PMO（プロセス監査）          [オンデマンド]
       └─ Tester（テスト実行）         [オンデマンド]
```

**Leaderの責務変更**: 技術レビューをTech Leadに、プロセス監査をPMOに委譲。Leaderは要件理解・タスク分解・意思決定・PO対話に集中。

**既存ロールとの差分**:

| 変更 | 内容 |
|------|------|
| Tech Lead新設 | leaderの技術レビュー責務を分離。LLM部分最適問題の構造的補完 |
| PMO新設 | hookでカバーできない意味的プロセス監査。旧PMO（廃止済み）とは異なるガードレール型定義 |
| Leader責務縮小 | レビュー責務をTL/PMOに委譲し、判断・指示に集中 |
| Coder/Scribe/Tester | 変更なし |

---

## 7. 残課題

| 課題 | 内容 |
|------|------|
| agent定義書作成 | Tech Lead/PMOの`agents/*.md`規約定義。具体的チェックリスト・判定基準 |
| ワークフロー図更新 | ワークフロー図.mdにTech Lead/PMOのレビュー工程を追加 |
| PMO hook設計 | hook層（構文的チェック）とagent層（意味的監査）の境界線確定 |
| RAM実測 | オンデマンド起動・停止のRAM回収が実際に機能するか検証 |
| コンテキスト消費記録 | coderのコンテキスト消費量をDB永続化する拡張（SubagentStop時にcontext_sizeカラム追加） |
| Leader規約強化（段階1） | TL/PMO分離前に、leader自身の規約にTech Lead観点・PMO観点のチェックリストを追加 |
| 実運用検証 | Leader規約強化→ボトルネック発生→TL/PMO分離の段階的移行プロセスの運用実績蓄積 |

---

## 出典

### プロジェクト内

| 出典 | 内容 |
|------|------|
| アーキテクチャ検討.md | 方式A～E比較・技術制約・推奨アーキテクチャ |
| アーキテクチャ再検討_20260202.md | 方式D評価・ペルソナ無効性・GP識別問題・PM+TL統合の経緯 |
| アーキテクチャ再検討_20260208.md | 方式E評価・50件超バグ調査・GA移行チェックリスト |
| たたき台.md | 役割構成の変遷記録（7役割→4役割+方式E） |
| Redmine #6098 | TaskSpawnGuardHook迂回防止。journal #25038～#25064に本ドキュメントの原議論を記録 |

### 外部

| 出典 | 内容 |
|------|------|
| [ClaudeCodeAgents](https://github.com/darcyegb/ClaudeCodeAgents) | Karen型QAエージェント集の原典 |
| [Wayfound Guardian Agent](https://www.wayfound.ai/) | Guardian Agentパターン |
| [Google ADK Draft-and-Review](https://developers.googleblog.com/developers-guide-to-multi-agent-patterns-in-adk/) | Generator+Critic品質ゲートパターン |
| [Addy Osmani Agent Teams](https://addyosmani.com/blog/claude-code-agent-teams/) | 並列レビューパターン |
| アーキテクチャ再検討_20260202.md §5 | ペルソナ無効性の学術研究5件 |

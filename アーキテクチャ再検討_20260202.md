# ticket-tasuki アーキテクチャ再検討

2026/02/02 議論記録

## 目的

既存のアーキテクチャ検討.md・たたき台.md・ワークフロー図.mdに対するレビューと、Conductorパターンの発見・検証を経た再検討。

---

## 1. 既存設計への指摘事項

### アーキテクチャ検討.md

| 指摘 | 内容 |
|------|------|
| オーケストレーター実装コスト過小評価 | エラーハンドリング・セッション管理・競合制御・出力パース・タイムアウト・クラッシュリカバリが必要。それ自体が1プロジェクト規模 |
| 設計原則と実装例の矛盾 | 「Redmineに書いてないことは存在しない」原則だが、CLIクラッシュ時はRedmine記載前に作業消失。懸念テーブルの1行では不足 |
| セッション継続の矛盾 | 動作フロー「コンテキスト破棄」vs 比較表「セッション継続可能」が未整理 |
| `claude -p`の制約 | ワンショット実行であり対話不可。方式Cが暗黙に前提とする「インタラクティブな疎通」は成立しない |
| 方式A再評価余地 | auto-compactionで設計上対処されており、真の問題はsubagent漏洩バグ(#14118)。修正されれば方式Aの実装コストが圧倒的に低い |

### たたき台.md

| 指摘 | 内容 |
|------|------|
| 管理:実装比率 | PO・PM・PMO・TL・リサーチャー・QA(管理6):開発者(実装1)。過剰な管理オーバーヘッド |
| PMO不要説 | LLMはチケット起票を忘れない。PMに統合し「規約監視」のみ定期バッチ化が効率的 |
| リサーチャーの差別化弱 | TLとの差がパーソナリティのみ。知識カットオフ制約により「最新動向把握」はWebSearch依存でTLと同等 |
| ワークフローの重さ | 1機能で最低20ステップ以上。レート制限プール共有下で3年運用はプロセス自体がボトルネック |

### ワークフロー図.md

| 指摘 | 内容 |
|------|------|
| 方式不整合 | アーキテクチャ検討.mdは方式C推奨だが、ワークフロー図はTask toolベース（方式A）。方式Cなら根本的に書き直しが必要 |

---

## 2. 技術的制約（調査で判明した事実）

### Claude Code本体の制約

| 制約 | 出典 | 状態 |
|------|------|------|
| カスタムsubagent(.claude/agents/)でMCPツール不可 | #13605, #15810 | OPEN |
| カスタムsubagentがMCP結果をハルシネーション | #13898 | OPEN |
| バックグラウンドsubagentでMCPツール不可 | #13254, 公式ドキュメント明記 | 仕様 |
| subagentのtool call詳細が親コンテキストに漏洩 | #14118, #15191 | OPEN |
| subagent→subagent呼び出し不可 | #4182, #19077 | 仕様 |
| 実行中セッションへの外部注入不可 | #15553 | 仕様 |
| レート制限: subagent・CLI・全方式で同一プール共有 | #12063, #7007 | 仕様 |
| `claude -p`: ワンショット実行、対話不可 | 公式ドキュメント | 仕様 |

### general-purpose vs カスタムagent

| 観点 | general-purpose | カスタムagent |
|------|----------------|---------------|
| MCPツール | **動作する** | **バグで不可** (#13605) |
| ツール制限 | 全ツール、制限不可 | tools/disallowedToolsで制限可 |
| システムプロンプト | 内部固定（編集不可） | Markdown本文がプロンプトになる |
| モデル選択 | 親継承のみ | sonnet/opus/haiku/inherit |
| hookのagent_type | `"general-purpose"` | agentのname値 |
| CLAUDE.md継承 | なし | なし |

### 実証結果: general-purpose + Redmine MCP

**動作確認済み（本セッションで検証）:**
- `list_versions_tool`: 8バージョン取得成功
- `list_epics_tool`: 2 Epic取得成功
- `get_project_structure_tool`: Epic→Feature階層を正常取得
- claude-naggerのhookブロック: 1回目ブロック→2回目通過（設計通り）

### 実証結果: subagentのセッション構造

```
親セッション:     798c7b86-8616-4ac9-b446-b29b3d255464
subagent a1d59ae: session_id = 798c7b86 (親と共有)
                  agent_id   = a1d59ae  (個別付与)
                  agent_type = general-purpose
```

- トランスクリプト: `subagents/agent-{agent_id}.jsonl` に分離保存
- コンテキストウィンドウ: サブエージェントは独立（親の200kとは別）
- ただしコンテキスト漏洩バグ(#14118)により親への流入あり

### 実証結果: トークン消費（成功subagent a1d59ae）

```
input_tokens:  17       (ほぼゼロ — キャッシュが効いている)
output_tokens: 25
cache_read:    259,388
cache_create:  8,977
4回のMCPツール呼び出し（retry含む）
```

---

## 3. 既存オーケストレーター調査

### 主要プロジェクト（2026/02時点）

| プロジェクト | 言語 | 方式 | 特記事項 |
|-------------|------|------|----------|
| TeammateTool (公式) | N/A | feature-flagged | v2.1.19バイナリに発見。5スワームパターン。GA時期不明 |
| claude-squad | Go | tmux+worktree | 5.6k stars, v1.0.14安定版。プロセスマネージャ（オーケストレーターではない） |
| claude-flow | TS | MCP swarm | 13.5k stars, **v3 alpha**。336 open issues。基本動作すら不明確(#958) |
| Swarm (parruda) | Ruby | v1:複数プロセスMCP → **v2:単一プロセスに移行** | 複数プロセス方式の困難さを実証 |
| CCPM | Plugin | GitHub Issues+worktree | ticket-tasukiの「Redmine=外部メモリ」と設計思想が一致 |
| CC-Mirror | Plugin | Conductor | **外部依存ゼロ。TaskCreate/TaskUpdate/Taskで完結** |

### claude-flow評価: カスタマイズベースとして不推奨

理由: alpha品質、過剰な複雑さ（Q-Learning/MoE/Byzantine合意等）、上流不安定、ticket-tasuki要件の10%しか使わない。

### Swarm v1→v2移行の教訓

複数プロセスMCP通信（方式C相当）→ 単一プロセス（方式A相当）に再設計。プロセス間通信のオーバーヘッドと複雑さが原因と推測。

### Redmine連携の既存実装

**存在しない。** GitHub Issues連携(CCPM)はあるがRedmine連携は未発見。

---

## 4. Conductorパターン（方式D）

CC-Mirrorの「Conductor」から着想。**Claude Codeの既存機能のみで成立する方式。**

### 構造

```
メインセッション (Conductor)
├── TaskCreate: タスク分解 + blockedBy依存関係定義
├── Task(subagent_type="general-purpose")
│   prompt: agents/scribe.mdの規約 + タスク指示
│   → Redmine MCPでチケット読み書き
├── Task(subagent_type="general-purpose")
│   prompt: agents/coder.mdの規約 + タスク指示
│   → Serena MCPでコード操作
└── TaskList → unblockされたタスクを検出 → 次を起動
```

### 方式比較（更新版）

| 観点 | A: subagent | B: Agent SDK | C: CLI+Redmine | **D: Conductor** |
|------|-------------|-------------|----------------|------------------|
| 追加実装 | 低（既存） | 中 | 高 | **なし** |
| MCP | カスタム:不可 / GP:可 | 可 | 可 | **可（GP使用）** |
| コンテキスト分離 | 独立（漏洩バグあり） | 独立 | 物理分離 | **独立（漏洩バグあり）** |
| タスク遷移 | 手動 | 自由 | オーケストレーター | **blockedByで宣言的** |
| ツール制限 | カスタム:可 / GP:不可 | 自由 | N/A | **不可（ソフト制約）** |
| バックグラウンド並列 | 可 | 可 | 可 | **可（ただしMCP不可）** |
| 暗黙知排除 | hook併用 | 別途実装 | Redmine強制 | **prompt+hook** |
| 外部依存 | なし | SDK+API | Python+オーケストレーター | **なし** |

### 制約

- `run_in_background=true`ではMCPツール使用不可（#13254, 公式ドキュメント）→ Redmine MCP使用時はフォアグラウンド（順次実行）が必要
- agent_type=general-purposeで全subagentが同一識別 → hookでの役割別規約注入不可
- ツール制限なし → プロンプトによるソフト制約のみ

---

## 5. ペルソナ（人格設定）の有効性

### 学術研究の知見

| 研究 | 結論 |
|------|------|
| Playing Pretend (SSRN, 2025/12) | 専門家ペルソナは事実精度を改善しない |
| Persona Double-Edged Sword (arXiv, 2024) | 不適切なペルソナはバイアスを生み性能劣化 |
| "Helpful Assistant" Not Helpful (arXiv, 2023) | 162ペルソナ×4 LLM×2410問で検証。効果なしまたは小さな負の効果 |
| Principled Personas (arXiv, 2025/08) | 無関係なペルソナ詳細で**最大30%性能低下** |
| PromptHub分析 | GPT-3→GPT-4で効果減衰の報告 |

### Anthropic公式

Claude 4.x Best Practicesにペルソナ/ロールプロンプティングの推奨は**一切記載なし**。推奨: 明示的な行動指示、コンテキストと動機の提供、XMLタグ構造化。

### 意図

パーソナリティ記述（「神経質」「好奇心旺盛」等）は削除し、**具体的なタスク指示と規約**に置き換える。agents/*.mdのMarkdown本文はカスタムagent用frontmatterとしてではなく、Conductorのpromptから参照する「規約定義書」として利用する。

---

## 6. claude-naggerとの統合課題

### SubagentStartフックの能力（公式ドキュメント確認済み）

- `agent_type`でマッチング可能
- `additionalContext`でsubagentにコンテキスト注入可能
- ブロックは不可（通知のみ）

### 識別問題

Conductorパターンでは全subagentが`agent_type=general-purpose`。claude-naggerのconfig.yamlのsubagent_types（scribe/coder/tester）は**マッチしない。** 全subagentに`subagent_default`規約のみ適用。

### session_startup_hookの動作（コードから確認）

```
PreToolUse発火時:
  tool_name == "Task" → スキップ (L303-307)
  SubagentMarkerManager.is_subagent_active() →
    true  → subagentフロー（overrides解決）
    false → main agentフロー
```

- Conductorの通常ツール呼び出し（Read, Bash等）: main agentフローに入る
- ConductorのTask tool呼び出し: スキップされる（正しい）
- subagentの初回ツール呼び出し: subagentフローでブロック（1回限り）

### repeatedメッセージの矛盾

config.yaml repeated:
```
[ ] チケット読み取りはscribe subagentに委譲
[ ] コード編集はcoder subagentに委譲
```

これはmain agentのトークン閾値超過時に表示される。Conductorパターンでは「scribe/coderに委譲」が矛盾。

### 未解決課題

config.yamlは1つだが、使用文脈は2つ（Leaderパターン / Conductorパターン）。書き換えればどちらかが壊れる。

選択肢:
- (a) claude-naggerに動作モード概念を追加（改修必要）
- (b) Conductorパターン採用時にconfig.yaml書き換え（Leaderパターン不可）
- (c) repeatedを両パターンで矛盾しない共通ルールのみにする
- (d) パターン確定まで保留

---

## 7. 推奨方針

### 短期（現時点）

- **方式D（Conductor + general-purpose + Redmine MCP）で小さく検証**
- 役割は最小限: Conductor + 開発者 + TL の3役割
- agents/*.mdは「規約定義書」としてpromptから参照
- claude-naggerはガードレール（禁止事項の強制）に専念
- config.yaml問題は保留（パターン確定後に対処）

### 中期

- #13605修正後: カスタムagentに移行 → hookベースの役割別規約注入が可能に
- TeammateTool GA後: 公式機能ベースに移行を検討
- バックグラウンド+MCP制約の回避策検証

### 長期

- Redmine連携の差別化部分を確立
- オーケストレーション自動化（Redmine webhook → タスク遷移）

---

## 8. general-purpose識別問題の調査結果

### 問題

Conductorパターンでは全subagentが`agent_type=general-purpose`。claude-naggerのconfig.yamlで定義するsubagent_types（scribe/coder/tester）と**マッチしない**。結果、役割別の規約注入が不可能。

### 技術的事実（公式ドキュメント・コード調査）

| 事実 | 出典 |
|------|------|
| PreToolUse hookのinput_dataにtool_input（ツールへの入力パラメータ）が含まれる | ClaudeCodeHooks.md L496-514 |
| Task toolのtool_inputにはprompt, subagent_type, description等が含まれる | 実セッションでのhookダンプ検証 |
| SubagentStart hookでadditionalContextをsubagentに注入可能 | 公式Hooks Reference |
| SubagentStart hookのinput_dataにagent_id含まれる | SubagentStart仕様 |
| subagentのトランスクリプトは`subagents/agent-{agent_id}.jsonl`に分離保存 | 実セッションで確認 |
| updatedInputでPreToolUseのツール入力を変更可能 | ClaudeCodeHooks.md L692-709 |
| claude-naggerのsession_startup_hookはTask toolをスキップ（L303-307） | session_startup_hook.py |

### 解決策

#### 方式A: PreToolUse(Task)でtool_input記録 → SubagentStartで紐付け

```
1. PreToolUse発火（tool_name=Task）
2. tool_input.promptからROLE識別（例: "scribe"含む→scribe）
3. 一時ファイルに{pending_role: "scribe"}記録
4. SubagentStart発火 → pending_roleを読み取りagent_idと紐付け
5. subagentのPreToolUse → agent_idから役割特定 → 役割別規約ブロック
```

**問題**: 並列Task呼び出し時の順序保証なし。Task AとTask Bを同時起動した場合、PreToolUseとSubagentStartの対応が崩れる可能性。

#### 方式B: SubagentStartでtranscript読み取り

```
1. SubagentStart発火 → agent_idを取得
2. subagents/agent-{agent_id}.jsonl を読み取り
3. 最初のuserメッセージ（=Conductorのprompt）から役割を識別
```

**問題**: SubagentStart時点でtranscriptファイルが書き込み済みかタイミング依存。ファイルが未生成の可能性あり。

#### 方式C: promptにROLEプレフィックス埋込 → transcript解析（推奨）

```
Conductor側:
  Task(prompt="[ROLE:scribe] Redmineチケット#123を読み取り...")

claude-nagger側（subagent初回PreToolUse時）:
  1. agent_idからtranscriptパスを特定
  2. transcriptの最初のuserメッセージを読み取り
  3. [ROLE:xxx]パターンを抽出
  4. 役割をマーカーファイルに記録
  5. 以降のPreToolUseでは記録済み役割を参照
```

**利点**:
- SubagentStartのタイミング問題を回避（初回ツール使用時に遅延解決）
- claude-naggerのsession_startup_hookは初回PreToolUseで既に発火するため、ここに組み込める
- promptは必ずtranscriptの最初のメッセージとして記録される（実証済み）
- 並列起動でもagent_id→transcript→prompt→ROLE の対応は一意に確定

**制約**:
- Conductor側でpromptに`[ROLE:xxx]`プレフィックスを含める規約が必要
- カスタムagentの#13605修正後は不要になる（移行パスあり）

#### 方式D: updatedInputでsubagent_type書換

```
PreToolUse(Task)発火時:
  1. tool_input.promptから役割識別
  2. updatedInputでsubagent_typeをカスタムagent名に書換
```

**問題**: subagent_typeはClaude Code内部のagent起動処理に影響する。未検証の書換はエラーや予期しない動作の原因となる可能性。Claude Codeがこの書換を拒否するリスクあり。

### 推奨: 方式C

方式Cを推奨する理由:
1. 実装が最も確実（タイミング問題なし、並列安全）
2. claude-naggerの既存フロー（初回PreToolUseでブロック→規約注入）に自然に統合可能
3. Conductor側の要件は`[ROLE:xxx]`プレフィックスのみ（軽量）
4. #13605修正後のカスタムagent移行時にclaude-nagger側の識別ロジックを差し替えるだけで済む

### 実装に必要な変更

| 対象 | 変更内容 |
|------|---------|
| claude-nagger session_startup_hook | subagent初回PreToolUse時にtranscript読み取り→ROLE抽出→マーカーに役割記録 |
| claude-nagger SubagentMarkerManager | マーカーにroleフィールド追加 |
| claude-nagger config.yaml | subagent_typesのマッチング条件にrole値を追加 |
| ticket-tasuki agents/*.md | Conductor用promptテンプレートに`[ROLE:xxx]`プレフィックス規約を追加 |
| ticket-tasuki Conductor | Task呼び出し時にpromptへ`[ROLE:xxx]`プレフィックスを付与する運用規約 |

---

## 出典（追加分）

| 出典 | 内容 |
|------|------|
| [CC-Mirror SKILL.md](https://github.com/numman-ali/cc-mirror/blob/main/src/skills/orchestration/SKILL.md) | Conductorパターンの原典 |
| [claude-squad](https://github.com/smtg-ai/claude-squad) | tmux+worktreeベースのプロセスマネージャ |
| [CCPM](https://github.com/automazeio/ccpm) | GitHub Issues駆動のプロジェクト管理 |
| [Claude 4.x Best Practices](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/claude-4-best-practices) | 公式プロンプティング推奨 |
| [Playing Pretend (SSRN)](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=5879722) | ペルソナ有効性研究 |
| [Principled Personas (arXiv)](https://arxiv.org/abs/2508.19764) | ペルソナ感度研究 |
| [Hooks Reference](https://code.claude.com/docs/en/hooks) | SubagentStart/additionalContext仕様 |
| [Sub-agents Reference](https://code.claude.com/docs/en/sub-agents) | general-purpose/カスタムagent仕様 |
